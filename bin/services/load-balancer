#!/usr/bin/env node
var lb = require('../../lib/load-balancer');
var cluster = require('cluster');
var config = require('../../config');

lb.start({}, function(err, app){
  if (err) {
    throw err;
  }
  console.log('lb started', app.server.address())
});

if (config.env === 'dev') {
  console.log('using dev mode, no cluster')
} else {
  if (cluster.isMaster) {
      var numWorkers = require('os').cpus().length;

      console.log('Master cluster setting up ' + numWorkers + ' workers...');

      for(var i = 0; i < numWorkers; i++) {
          cluster.fork();
      }

      cluster.on('online', function(worker) {
          console.log('Worker ' + worker.process.pid + ' is online');
      });

      cluster.on('exit', function(worker, code, signal) {
          console.log('Worker ' + worker.process.pid + ' died with code: ' + code + ', and signal: ' + signal);
          console.log('Starting a new worker');
          cluster.fork();
      });
  } else {
    lb.start({}, function(err, app){
      if (err) {
        throw err;
      }
      console.log('lb started', app.server.address());
    });
  }
}